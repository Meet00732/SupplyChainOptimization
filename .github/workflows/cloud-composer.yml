name: Deploy to Compute Engine & Cloud Composer

on:
  push:
    branches: testing-pipeline
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Where to deploy Airflow'
        required: true
        default: 'compute_engine'
        type: choice 
        options:
          - local
          - cloud_composer
          - compute_engine
          - both

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Data_Pipeline/requirements-test.txt

      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd)/Data_Pipeline:$(pwd)" >> $GITHUB_ENV
          echo "PYTHONPATH set to $(pwd)/Data_Pipeline:$(pwd)"

      - name: Run Unit Tests
        run: |
          python -m unittest discover -s Data_Pipeline/tests -p "test*.py"

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      # ‚úÖ **Assign IAM Roles from GitHub Actions (Instead of Inside VM)**
      - name: Grant Required IAM Roles
        run: |
          echo "üöÄ Granting IAM roles to service account..."
          gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID }} \
            --member "serviceAccount:cloudcomputefordocker@primordial-veld-450618-n4.iam.gserviceaccount.com" \
            --role "roles/compute.admin"
          gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID }} \
            --member "serviceAccount:cloudcomputefordocker@primordial-veld-450618-n4.iam.gserviceaccount.com" \
            --role "roles/storage.admin"
          gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID }} \
            --member "serviceAccount:cloudcomputefordocker@primordial-veld-450618-n4.iam.gserviceaccount.com" \
            --role "roles/iam.serviceAccountUser"
          echo "‚úÖ IAM roles successfully assigned!"

      # ‚úÖ **Ensure SSH Key Exists**
      - name: Persist SSH Key to Compute Engine
        run: |
          echo "üöÄ Persisting SSH Key to Compute Engine..."
          if [ ! -f ~/.ssh/github-actions-key ]; then
            ssh-keygen -t rsa -b 4096 -C "github-actions" -N "" -f ~/.ssh/github-actions-key
            echo "‚úÖ SSH Key generated!"
          else
            echo "‚úÖ SSH Key already exists!"
          fi
          PUBLIC_KEY=$(cat ~/.ssh/github-actions-key.pub)
          gcloud compute instances add-metadata airflow-server --zone us-central1-a --metadata=ssh-keys="${{ secrets.COMPUTE_ENGINE_USER }}:$PUBLIC_KEY"
          echo "‚úÖ SSH Key added to Compute Engine!"

      # ‚úÖ **Ensure Compute Engine is Running**
      - name: Ensure Compute Engine is Running
        run: |
          INSTANCE_STATUS=$(gcloud compute instances describe airflow-server --zone us-central1-a --format="value(status)" || echo "STOPPED")
          if [[ "$INSTANCE_STATUS" != "RUNNING" ]]; then
            echo "üöÄ Starting Compute Engine instance..."
            gcloud compute instances start airflow-server --zone us-central1-a
            echo "‚úÖ Compute Engine started."
          else
            echo "‚úÖ Compute Engine is already running."
          fi

      # ‚úÖ **Wait for SSH to be Ready**
      - name: Wait for SSH Access
        run: |
          echo "üöÄ Waiting for airflow-server to be reachable..."
          EXTERNAL_IP=$(gcloud compute instances describe airflow-server --zone us-central1-a --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
          for i in {1..10}; do
            nc -zv -w5 $EXTERNAL_IP 22 && break
            echo "‚è≥ SSH not available yet. Retrying in 10 seconds..."
            sleep 10
          done
          echo "‚úÖ SSH is now available!"

      # ‚úÖ **Sync Airflow Project Files to Compute Engine**
      - name: Sync Airflow Project Files to Compute Engine
        run: |
          echo "üöÄ Syncing project files to airflow-server..."
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/github-actions-key" --exclude '.git' . \
            ${{ secrets.COMPUTE_ENGINE_USER }}@${{ secrets.COMPUTE_ENGINE_IP }}:/opt/airflow
          echo "‚úÖ Files synced successfully."

      # ‚úÖ **Deploy Airflow on Compute Engine**
      - name: Deploy Airflow on Compute Engine
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/github-actions-key ${{ secrets.COMPUTE_ENGINE_USER }}@${{ secrets.COMPUTE_ENGINE_IP }} << 'EOF'
            echo "üöÄ Ensuring Docker is installed..."
            if ! command -v docker &> /dev/null; then
              sudo apt-get update -y
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            fi

            echo "üöÄ Ensuring Docker Compose is installed..."
            if ! command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep -Po '"tag_name": "\K.*?(?=")')
              sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
            fi

            echo "‚úÖ Docker & Compose installed."
            sudo usermod -aG docker $USER
            newgrp docker
            sudo systemctl restart docker

            echo "üöÄ Ensuring GCP Key File exists..."
            echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' | jq . > /opt/airflow/gcp-key.json
            chmod 644 /opt/airflow/gcp-key.json
            sudo chown ubuntu:docker /opt/airflow/gcp-key.json
            echo "‚úÖ GCP Key File Created."
          EOF

      # ‚úÖ **Retrieve Airflow Webserver IP**
      - name: Get Airflow Webserver IP
        run: |
          EXTERNAL_IP=$(gcloud compute instances describe airflow-server --zone us-central1-a --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
          echo "üåç Airflow UI is available at: http://$EXTERNAL_IP:8080"

      # ‚úÖ **Deploy to Cloud Composer (Optional)**
      - name: Deploy DAGs to Cloud Composer
        if: ${{ inputs.deployment_target == 'cloud_composer' || inputs.deployment_target == 'both' }}
        run: |
          echo "üöÄ Uploading DAGs to Cloud Composer..."
          gcloud storage cp -r Data_Pipeline/dags gs://your-cloud-composer-bucket/dags
          echo "‚úÖ DAGs uploaded successfully!"

      # ‚úÖ **Remove SSH Key After Deployment (Security)**
      - name: Remove SSH Key
        run: rm -f ~/.ssh/github-actions-key ~/.ssh/github-actions-key.pub
